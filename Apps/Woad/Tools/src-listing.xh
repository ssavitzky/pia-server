<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head>
<hide>
  <set name="spath">
    <if>&SITE:sourcePrefix;
	<then><subst match="^&SITE:sourcePrefix;"
	             result="">&LOC:path;</subst></then>
	<else>&LOC:path;</else>
    </if></set>
  <if> <get name="spath" />
       <else><set name="spath">/</set></else>
  </if>
  <set name="sroot">
    <if>&SITE:sourcePrefix;
	<then>&SITE:sourcePrefix;</then>
	<else></else>
    </if></set>
  <set name="tail"><if> <logical op="and">
			  <get name="PATH_INFO"/>
			  <test exact="yes" match="\/">&spath;</test>
			</logical>
		        <then>/<get name="PATH_INFO"/></then>
		        <else><get name="PATH_INFO"/></else>
  </if></set>
  <if> <logical op="and">
	 <get name="tail" />
	 <test not="not" match="^\/"><get name="tail"/></test>
       </logical>
       <then><set name="tail">/<get name="tail"/></set></then>
  </if>
</hide>
<title>&spath;&tail; : Woad source listing</title>
</head><body bgcolor="#ffffff">
<hide>
  <set name="VAR:format"><if> &FORM:all; <then>complete</then>
    <else-if>&FORM:detail;<then>detail</then></else-if>
    <else>filtered</else>
  </if></set>
  <set name="decoratedPath">
	<decoratePath base="&sroot;">[SRC]&spath;&tail;</decoratePath></set>

  <set name="tpath"><mapSrcToTarget>&LOC:path;&tail;</mapSrcToTarget></set>
  <set name="npath"><mapSourceToNote>&LOC:path;&tail;</mapSourceToNote></set>

  <if> <test not="not" match="\.[a-zA-Z0-9]+$">&spath;&tail;</test>
       <then>
	 <set name="xloc">&spath;&tail;</set>
       </then>
       <else>
	 <set name="xloc">
	    <subst match="/[^/]*$" result="">&spath;&tail;</subst></set>
       </else>
  </if>
  <set name="xloc"><subst match="^//" result="/">&xloc;</subst></set>

  <!-- Ensure that form submissions don't get redirected!  -->
  <set name="formLoc">
    <if> <test match="\/$">&LOC:path;&tail;</test>
         <then>&LOC:path;&tail;</then>
         <else>&LOC:path;&tail;/</else>
    </if>
  </set>

</hide>

<table bgcolor="#99ccff" cellspacing="0" border="0" width="100%">
  <tr> <td>
	     <table><!-- the nested table shrink-wraps its contents     -->
	            <!-- so it doesn't get spread out by the width=100% -->
	       <tr><th align="left">
		      <big> &nbsp;<ss><a href="/.Woad/">WOAD</a></ss></big>
		   </th>
		   <th align=left>
		      <big> <i>directory listing:</i>
		 	    <code>&decoratedPath; &tail;</code>
		      </big> 
		   </th>
	       </tr>
	       <tr>
		 <td align="right">-&gt;&nbsp;</td>
		 <td>
		      <xf fmt="filtered" href="&LOC:path;">filtered</xf>
		      <xf fmt="complete" href="&LOC:path;?all">complete</xf>
		      <if><get name="tpath" />
		          <then>
		      	    <a href="&tpath;">&lt;server&gt;</a>
		      	    <a href="&tpath;" target="server">&lt;!&gt;</a>
		          </then>
		      </if>
		      <if><get name="npath" />
		          <then>
		      	    <a href="&npath;">[URL annotations]</a>
		          </then>
		      </if>
		      <a href="/.Woad/help.xh#views">[help]</a>
		 </td>
		</tr>
	     </table>
	</td>
  </tr>
</table>

<hide>
    <!-- Create a new note:  have to do this before listing the directory -->

    <if> <get name="FORM:create" />
	 <then>
	   <if> <status item="exists" src="&FORM:label;.ww" />
	        <else><!-- create new note -->
	    <output dst="&FORM:label;.ww"><make name="note">
		<make name="title"><get name="FORM:title" /></make>
		<make name="created">&dateString;</make>
		<make name="summary">
		    <parse><get name="FORM:summary" /></parse>
		</make>
		<make name="content">
		    <parse><get name="FORM:content" /></parse>
		</make>
</make><!-- note created using quick form -->
</output>
		</else>
	   </if>
	 </then>
    </if>

    <doc> Now locate the files.  Note that we don't need <code>&amp;tail;</code>
	  here because we're browsing around in the source directories, which
	  are all perfectly real (though referred to as ``virtual'').
    </doc>
    <listNoteFiles>&LOC:path;</listNoteFiles>
</hide>

<if> <status item="exists" src="HEADER.ww" />
     <then>
	<set name="haveHeader">yes</set>
	<load-note>HEADER.ww</load-note>
	<hr />
	<displayNoteAsHeader />
     </then>
</if>

<index-bar name="Notes">Notes Files Views HEADER</index-bar>

<form action="&formLoc;" method="GET"><!-- === PIA isn't passing POST again === -->
  <input type="hidden" name="path" value="&LOC:path;/&tail;" />
<table bgcolor="white" border="2">
  <!-- First list the indices -->
<if>&indexFiles;<then>
  <tr> <th bgcolor="#cccccc" width="150"> indices </th>
       <th bgcolor="#cccccc" colspan="2" align="left"> description / link to
       help </th> 
  </tr>
</then></if>
<repeat>
  <foreach entity="f">&indexFiles;</foreach>
  <let name="label"><subst match="\.[^.]*$" result="">&f;</subst></let>
  <tr> <td align="left" valign="top">
		<a href="&f;"><code>&label;</code></a>
       </td>
       <td colspan="2" valign="top">
		 <describeIndex>&f;</describeIndex>
       </td>
  </tr>
</repeat>

  <!-- Next, list the notes -->
  <tr> <th bgcolor="#cccccc" width="150"> source notes </th>
       <th bgcolor="#cccccc" colspan="2" align="left"> title / summary </th>
  </tr>
<repeat>
  <foreach entity="f">&noteFiles;</foreach>
  <let name="label"><subst match="\.[^.]*$" result="">&f;</subst></let>
  <tr> <td align="left" valign="top" bgcolor="yellow">
		<a href="&f;"><code>&label;</code></a>
       </td>
       <td colspan="2" valign="top" bgcolor="yellow">
		 <describeNote>&LOC:path;&tail;/&f;</describeNote>
       </td>
  </tr>
</repeat>

<if>&npath;
  <then>
    <hide>
      <set name="VAR:nfiles">
        <text sort><status item="files" src="&npath;" /></text>
      </set>
      <set name="VAR:nnoteFiles">
        <repeat><foreach entity="f">&nfiles;</foreach>
	   <if><rejectNote>&f;</rejectNote>
	       <else>&f;</else>
	   </if>
        </repeat>
     </set>
    </hide>
  <!-- list the corresponding URL annotations, if any -->
  <if>&nnoteFiles; <then>
    <tr> <th bgcolor="#cccccc" width="150"> page notes </th>
	 <th bgcolor="#cccccc" colspan="2" align="left"> <em>(From the URL
	 annotations for <a href="&npath;">&npath;</a>)</em></th>
    </tr>
  </then></if>
  <repeat>
    <foreach entity="f">&nnoteFiles;</foreach>
    <let name="label"><subst match="\.[^.]*$" result="">&f;</subst></let>
    <tr> <td align="left" valign="top" bgcolor="#99ccff">
		  <a href="&npath;/&f;"><code>&label;</code></a>
	 </td>
	 <td colspan="2" valign="top" bgcolor="#99ccff">
		   <describeNote>&npath;/&f;</describeNote>
	 </td>
    </tr>
  </repeat>
  </then>
</if>
    
  <!-- Finally, the form for creating a new note (the easy way) -->
  <tr> <th bgcolor="#cccccc" width="150"> new note </th>
       <th bgcolor="#cccccc" colspan="2" align="left">
    	    Enter note text or use &nbsp;&nbsp;&nbsp;
    	    <a href="/.Woad/Tools/new-note?path=&xloc;">[advanced form]</a> 
       </th>
  </tr>
  <tr> <td valign="top">
    	  <select name="label"> 
	       	   <option selected="selected"><uniquify>note</uniquify></option>
	       	   <option><uniquify>bug</uniquify></option>
	       	   <option><uniquify>wish</uniquify></option>
	       	   <option><uniquify>see-also</uniquify></option>
	       	   <option>&date;-&hour;&minute;</option>
	       	   <option>&date;</option>
	       	   <if>&haveHeader;<else><option>HEADER</option></else></if>
	  </select><br />
 	  <input name="create" value="Create Note" type="submit" />
       </td>
       <td valign="top" colspan="2">
	  <textarea name="summary" cols="60" rows="4" wrap="wrap"></textarea>
       </td>
  </tr>
</table>
</form>

<!-- ==================================================================== -->
<!-- === actually this wants to be a separate section, on the index bar. -->
<tool-bar />


<index-bar name="Files">Notes Files Views HEADER</index-bar>

<define element="File">
  <doc> This is cheating.  We really need to make the index a namespace, and
	look up the actual files in it.  Unfortunately, this doesn't work.
	The problem with the cheat is that if the index gets out of date,
	we're hosed.  We could compare dates...
  </doc>
  <action>
    <tr> <td> <a href="&attributes:name;"><code>&attributes:name;</code></a>
	 </td>
	 <td> &nbsp;
	      <logical op="or">
	        <get name="attributes:title"/>
	        <if> <get name="attributes:dscr"/>
	      	     <then><em><get name="attributes:dscr"/></em></then>
	        </if>
	        <em><if> <get name="attributes:tdscr" />
	      	    <then> <get name="attributes:tdscr" />
	      	 	   <if> <test match="file">
	      			  <get name="attributes:tdscr" /></test>
	      			<test match="directory">
	      			  <get name="attributes:tdscr" /></test>
	      			<else>file</else>
	      		   </if>	      	    </then>
	      	    <else>(unknown; probably text)</else>
	        </if></em>
	      </logical>
	 </td>
    </tr>
  </action>
</define>

<set name="dirIndex"><include src="&LOC:path;/dirIndex.wi"> </include></set>

<define element="rejectFile">
  <doc> decide whether to omit a file from the listing
  </doc>
  <action>
    <if> &FORM:all;
	<then> </then>
        <else><test match="~$">&content;</test>
              <test match=".bak$">&content;</test>
              <test match="^[.]">&content;</test>
              <test exact="yes" match="CVS">&content;</test>
	</else>
    </if>
  </action>
</define>
<set name="cvs-controlled"></set>

<if> &npath;
     <then>
       <yellow-note>
	 This is a source directory listing.  If there's a page here called
	 <code>index.html</code>, that's  probably what the browser will show
	 for it, but this can be changed in server configuration files that
	 <ss>WOAD</ss> doesn't understand yet.
       </yellow-note>
     </then>
</if>

<if>&tail;
    <then>
	<h3>Invalid source path <code>&spath;&tail;</code>.</h3>
	<p> The closest valid directory above it is
	    <code><a href="&LOC:path;/">&spath;/</a></code> 
	</p>
    </then>
  <else-if>&dirIndex;
    <then> 
	<table bgcolor="white" border="3">
	  <tr>
	    <th bgcolor="#cccccc"> filename </th>
	    <th bgcolor="#cccccc"> title/<em>description</em> </th>
	  </tr>
	  &dirIndex;
	</table>
    </then>
  </else-if>
    <else>
       <yellow-note>
	 This directory has not been indexed!  Indexing is done using the
	 <code>woad-index.pl</code> command, which you can find in
	 <code>PIA/src/apps/tools</code> 
       </yellow-note>
	<table bgcolor="white">
	<repeat>
	  <foreach entity="f">
	     <text sort><status item="files" src="&LOC:path;" /></text>
	  </foreach>
	  <if><rejectFile>&f;</rejectFile>
	      <else>
		<tr><td align="left"><a href="&f;"><code>&f;</code></a></td>
		    <td> <if> &dirIndex;
			      <then><xget name="dirIndex:&f;:tdscr"/>
			      </then>
			 </if>
		    </td>
		</tr>
	      </else>
	  </if>
	  <if><test exact="yes" match="CVS">&f;</test>
	      <then><set name="cvs-controlled">yes</set></then>
	  </if>
	</repeat>
	</table>
    </else>
</if>
<hide>
<ul></ul><!-- correct indentation -->
</hide>

<if> <get name="cvs-controlled"/>
     <then> Note: this source directory is under CVS control.
     </then>
</if>


<!-- ==================================================================== -->
<index-bar name="Views">Notes Files Views HEADER</index-bar>

<if> &tpath;
     <then>
	<p> This page is a <ss>WOAD</ss> listing of the application source
	    directory <code>&spath;</code>
	    <br />
    	    It corresponds to the application URL <code>&tpath;</code>
	</p>
	<p> There are two options for viewing the associated application
	    document: 
	</p>
	<table bgcolor="white" width="90%" cellpadding="5" border="2"
	       align="center" >
	  <tr>
	    <td valign="top"> 
		 <a href="&npath;">View&nbsp;[URL&nbsp;annotations].</a>
	    </td>
	    <td> This will show you the <ss>WOAD</ss> annotations associated
		 with this URL.  It will also show you a listing, similar to
		 this one, of the page <em>as it came from the server.</em>
		 This can be useful for debugging an active document.
	    </td>
	  </tr>
	  <tr>
	    <td valign="top" align="right"> 
		 <a href="&tpath;">View page&nbsp;on&nbsp;&lt;server&gt;.</a>
	         <br />
	    	 <a href="&tpath;"
    	    	    target="server">...&nbsp;in&nbsp;&lt;!new&nbsp;window&gt;</a>
	    </td>
	    <td> This is a link to this page <em>on the server</em> -- in
		 other words, it's what a user will see if they browse to the
		 url that corresponds to this document.  
	    </td>
	  </tr>
	</table>	  
     </then>
     <else>
	<p> This page is a <ss>WOAD</ss> source listing of
	    <code>&spath;</code>. 
	</p>
	<yellow-note>
	  Either there is no URL on the server that corresponds to this file,
	  or <ss>WOAD</ss> does not yet know how to perform the appropriate
	  mapping. 
	</yellow-note>
     </else>
</if>
<p> 
</p>


<if> <status item="exists" src="&LOC:path;/HEADER.html" />
     <then>

<index-bar name="HEADER">Notes Files Views HEADER</index-bar>

<table bgcolor="#99ccff" cellspacing="0" border="0" width="100%">
  <tr><td>&nbsp;</td>
  <tr><th align="left">
    <h2><code>&spath;/HEADER.html</code></h2>
    </th>
  </tr>
</table>

<table bgcolor="#ffffff" border="1">
 <tr><td><small>
	   <include src="&LOC:path;/HEADER.html" tagset="HTML" />
	 </small>
     </td>
 </tr>
</table>
     </then>
</if>

<short-footer cvs-id="$Id: src-listing.xh,v 1.16 2000-07-21 22:48:21 steve Exp $" />
</body></html>
