<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head>
<hide>
  <set name="spath">
    <if>&SITE:sourcePrefix;
	<then><subst match="^&SITE:sourcePrefix;"
	             result="">&LOC:path;</subst></then>
	<else>&LOC:path;</else>
    </if></set>
</hide>
<title>&spath; : Woad source listing</title>
</head><body>
<hide>
  <set name="VAR:format"><if> &FORM:all; <then>complete</then>
    <else-if>&FORM:detail;<then>detail</then></else-if>
    <else>filtered</else>
  </if></set>
  <set name="tail"><if><get name="PATH_INFO"/>
		       <then>/<get name="PATH_INFO"/></then>
  </if></set>

  <doc> The following crockery is used to compute &amp;decoratedPath;,
	which is the path of the current directory ``decorated'' with
	".." links to the directories above "."
  </doc>
  <set name="depth">0</set>
  <set name="split"><subst match="/" result=" ">[SRC]&spath;</subst></set>
  <repeat>
    <foreach><text split>&split;</text></foreach>
    <set name="depth"><numeric op="sum">1 <get name="depth"/></numeric></set>
  </repeat>
  <set name="d">2</set>
  <set name="decoratedPath"><repeat><hide>
    </hide><foreach entity="f"><text split>&split;</text></foreach><hide>
    <set name="dots"><repeat><for start="&d;" stop="&depth;"/>../</repeat></set>
    <set name="d"><numeric op="sum">1 <get name="d"/></numeric></set>
    </hide><if> &dots;
	  <then><a href="&dots;">&f;</a>/</then>
	  <else>&f;</else>
  </if></repeat></set>

  <doc> Set other variables.
  </doc>
  <set name="tpath"><mapSrcToTarget>&LOC:path;&tail;</mapSrcToTarget></set>
  <set name="npath"><mapSourceToNote>&LOC:path;&tail;</mapSourceToNote></set>
</hide>

<table bgcolor="#99ccff" cellspacing="0" border="0" width="100%">
  <tr><th align="left">
    <h1><code>&decoratedPath; &tail;</code></h1>
    </th>
  </tr>
  <tr> <td>
	     <table><!-- the nested table shrink-wraps its contents     -->
	            <!-- so it doesn't get spread out by the width=100% -->
	       <tr><th align="left">
		      <big> &nbsp;<ss><a href="/.Woad/">WOAD</a></ss></big>
		   </th>
		   <th align=left>
		      <big> <get name="VAR:format"/> source directory
			    listing</big> 
		   </th>
	       </tr>
	       <tr>
		 <td align="right">-&gt;&nbsp;</td>
		 <td>
		      <xf fmt="filtered" href="&LOC:path;">filtered</xf>
		      <xf fmt="complete" href="&LOC:path;?all">complete</xf>
		      <if><get name="tpath" />
		          <then>
		      	    <a href="&tpath;">&lt;server&gt;</a>
		          </then>
		      </if>
		      <if><get name="npath" />
		          <then>
		      	    <a href="&npath;">[notes]</a>
		          </then>
		      </if>
		      <a href="/.Woad/help.xh#views">[help]</a>
		 </td>
		</tr>
	     </table>
	</td>
  </tr>
</table>

<index-bar name="Notes">Notes Files HEADER</index-bar>

<doc> Look for notes.
</doc>

<define element="rejectNote">
  <doc> decide whether to omit a note from the listing
  </doc>
  <action>
    <logical op="and">
	<test not="not" match="\.ww$">&content;</test>
	<test not="not" match="\.wi$">&content;</test>
    </logical>
  </action>
</define>

<define element="extract-title">
  <action>
    <extract><from><include src="&content;" /></from>
	     <name all="all">title</name> <content /></extract>
  </action>
</define>

<define element="describeNote">
  <doc> come up with a good description for a note.
  </doc>
  <action>
    <if> <test match="\.wi$">&content;</test>
	 <then><ss>WOAD</ss> <subst match="\.wi$" result="">&content;</subst>
		file
	 </then>
	 <else> <logical op="or">
		  <extract-title>&attributes:src;/&content;</extract-title>
	 	  <ss>WOAD</ss> note (untitled)
	 	</logical>
	 </else>
    </if>
  </action>
</define>


<table bgcolor="white">
<repeat>
  <foreach entity="f">
     <text sort>
  	<status item="files" src="&LOC:path;&tail;" />
     </text>
  </foreach>
  <if><rejectNote>&f;</rejectNote>
      <else>
  	<tr><th align="left"><a href="&f;">&f;</a></td>
	    <td> <describeNote src="&LOC:path;&tail;">&f;</describeNote>
	    </td>
	</tr>
      </else>
  </if>	  
</repeat>
</table>

<form action="/.Woad/src-note" method="post">
  <input type="hidden" name="path" value="&LOC:path;" />
  <table cellpadding="0" cellspacing="2" border="0" bgcolor="white">
    <tr> <th bgcolor="#cccccc"> Name </th> 
	 <th bgcolor="#cccccc"> Title </th> 
	 <th bgcolor="#cccccc"> [help] </th>
    </tr>
    <tr> <td> &nbsp;<input name="name" size="8" /> </td>
	 <td> &nbsp;<input name="title" size="30" /> </td>
	 <td> &nbsp;<input name="op" value="Add Note" type="submit" /> </td>
    </tr>
  </table>
</form>

<index-bar name="Files">Notes Files HEADER</index-bar>

<define element="File">
  <doc> This is cheating.  We really need to make the index a namespace, and
	look up the actual files in it.  Unfortunately, this doesn't work.
	The problem with the cheat is that if the index gets out of date,
	we're hosed.  We could compare dates...
  </doc>
  <action>
    <tr> <td> <a href="&attributes:name;"><code>&attributes:name;</code></a>
	 </td>
	 <td> <logical op="or">
	        <get name="attributes:title"/>
	        <get name="attributes:dscr"/>
	        <get name="attributes:tdscr"/>
	 </td>
    </tr>
</define>

<set name="dirIndex"><include src="&LOC:path;/dirIndex.wi"/></set>

<define element="rejectFile">
  <doc> decide whether to omit a file from the listing
  </doc>
  <action>
    <if> &FORM:all;
	<then> </then>
        <else><test match="~$">&content;</test>
              <test match=".bak$">&content;</test>
              <test match="^[.]">&content;</test>
              <test exact="yes" match="CVS">&content;</test>
	</else>
    </if>
  </action>
</define>
<set name="cvs-controlled"></set>
  
<if>&tail;
    <then>
	<h3>Invalid source path <code>&spath;&tail;</code>.</h3>
	<p> The closest valid directory above it is
	    <code><a href="&LOC:path;/">&spath;/</a></code> 
	</p>
    </then>
  <else-if>&dirIndex;
    <then> 
	<table bgcolor="white">
	  &dirIndex;
	</table>
    <then>
  </else-if>
    <else>
	<table bgcolor="white">
	<repeat>
	  <foreach entity="f">
	     <text sort><status item="files" src="&LOC:path;" /></text>
	  </foreach>
	  <if><rejectFile>&f;</rejectFile>
	      <else>
		<tr><td align="left"><a href="&f;"><code>&f;</code></a></td>
		    <td> <if> &dirIndex;
			      <then><xget name="dirIndex:&f;:tdscr"/>
			      </then>
			 </if>
		    </td>
		</tr>
	      </else>
	  </if>
	  <if><test exact="yes" match="CVS">&f;</test>
	      <then><set name="cvs-controlled">yes</set></then>
	  </if>
	</repeat>
	</table>
    </else>
</if>
<hide>
<ul></ul><!-- correct indentation -->
</hide>

<if> <get name="cvs-controlled"/>
     <then> Note: this source directory is under CVS control.
     </then>
</if>


<if> <status item="exists" src="&LOC:path;/HEADER.html" />
     <then>

<index-bar name="HEADER">Notes Files HEADER</index-bar>

<table bgcolor="#99ccff" cellspacing="0" border="0" width="100%">
  <tr><td>&nbsp;</td>
  <tr><th align="left">
    <h2><code>&spath;/HEADER.html</code></h2>
    </th>
  </tr>
</table>

<table bgcolor="#ffffff" border="1">
 <tr><td><small>
	   <include src="&LOC:path;/HEADER.html" tagset="HTML" />
	 </small>
     </td>
 </tr>
</table>
     </then>
</if>

<short-footer cvs-id="$Id: src-listing.xh,v 1.5 2000-06-21 01:07:22 steve Exp $" />
</body></html>
