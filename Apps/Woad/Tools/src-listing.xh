<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head>
<hide>
  <set name="spath">
    <if>&SITE:sourcePrefix;
	<then><subst match="^&SITE:sourcePrefix;"
	             result="">&LOC:path;</subst></then>
	<else>&LOC:path;</else>
    </if></set>
  <if> <get name="spath" />
       <else><set name="spath">/</set></else>
  </if>
  <set name="sroot">
    <if>&SITE:sourcePrefix;
	<then>&SITE:sourcePrefix;</then>
	<else></else>
    </if></set>
  <set name="tail"><if> <logical op="and">
			  <get name="PATH_INFO"/>
			  <test exact="yes" match="\/">&spath;</test>
			</logical>
		        <then>/<get name="PATH_INFO"/></then>
		        <else><get name="PATH_INFO"/></else>
  </if></set>
  <if> <logical op="and">
	 <get name="tail" />
	 <test not="not" match="^\/"><get name="tail"/></test>
       </logical>
       <then><set name="tail">/<get name="tail"/></set></then>
  </if>
</hide>
<title>&spath;&tail; : Woad source listing</title>
</head><body bgcolor="#ffffff">
<hide>
  <set name="VAR:format"><if> &FORM:all; <then>complete</then>
    <else-if>&FORM:detail;<then>detail</then></else-if>
    <else>filtered</else>
  </if></set>
  <set name="decoratedPath">
	<decoratePath base="&sroot;">[SRC]&spath;&tail;</decoratePath></set>

  <set name="tpath"><mapSrcToTarget>&LOC:path;&tail;</mapSrcToTarget></set>
  <set name="npath"><mapSourceToNote>&LOC:path;&tail;</mapSourceToNote></set>
</hide>
<table bgcolor="#99ccff" cellspacing="0" border="0" width="100%">
  <tr> <td>
	     <table><!-- the nested table shrink-wraps its contents     -->
	            <!-- so it doesn't get spread out by the width=100% -->
	       <tr><th align="left">
		      <big> &nbsp;<ss><a href="/.Woad/">WOAD</a></ss></big>
		   </th>
		   <th align=left>
		      <big> directory listing:
		 	    <code>&decoratedPath; &tail;</code></big> 
		   </th>
	       </tr>
	       <tr>
		 <td align="right">-&gt;&nbsp;</td>
		 <td>
		      <xf fmt="filtered" href="&LOC:path;">filtered</xf>
		      <xf fmt="complete" href="&LOC:path;?all">complete</xf>
		      <if><get name="tpath" />
		          <then>
		      	    <a href="&tpath;">&lt;server&gt;</a>
		          </then>
		      </if>
		      <if><get name="npath" />
		          <then>
		      	    <a href="&npath;">[URL annotations]</a>
		          </then>
		      </if>
		      <a href="/.Woad/help.xh#views">[help]</a>
		 </td>
		</tr>
	     </table>
	</td>
  </tr>
</table>

<index-bar name="Notes">Notes Files HEADER</index-bar>

<doc> Look for notes.
</doc>

<define element="rejectNote">
  <doc> decide whether to omit a note from the listing
  </doc>
  <action>
    <logical op="and">
	<test not="not" match="\.ww$">&content;</test>
	<test not="not" match="\.wi$">&content;</test>
    </logical>
  </action>
</define>

<define element="extract-title">
  <action>
    <extract><from><include src="&content;"> </include></from>
	     <name all="all">title</name> <content /></extract>
  </action>
</define>

<define element="summarize">
  <action>
    <extract><from><include  tagset="/.Woad/woad-web.ts" quoted src="&content;" /></from>
	     <name all="all">summary</name> <content /></extract>
  </action>
</define>

<define element="describeNote">
  <doc> come up with a good description for a note.
  </doc>
  <action>
    <if> <test match="\.wi$">&content;</test>
	 <then> <let name="basename">
		     <subst match="\.wi$" result="">&content;</subst>
		</let>( <ss>WOAD</ss>
			<a href="/.Woad/help.xh#&basename;">&basename;</a>
			file ) 
	 </then>
	 <else> <logical op="or">
		  <extract-title>&attributes:src;/&content;</extract-title>
	 	  ( <ss>WOAD</ss> annotation: untitled )
	 	</logical>
	 </else>
    </if>
  </action>
</define>


<form action="/.Woad/Tools/new-note" method="get">
  <input type="hidden" name="path" value="&LOC:path;" />
<table bgcolor="white" width="90%">
  <tr> <th bgcolor="#cccccc" width="150"> label </th>
       <th bgcolor="#cccccc" colspan="2"> title / summary </th>
  </tr>
<repeat>
  <foreach entity="f">
     <text sort>
  	<status item="files" src="&LOC:path;&tail;" />
     </text>
  </foreach>
  <let name="label"><subst match="\.[^.]*$" result="">&f;</subst></let>
  <if><rejectNote>&f;</rejectNote>
      <else>
  	<tr><th align="left"><a href="&f;">&label;</a></th>
	    <td colspan="2">
	  	<describeNote src="&LOC:path;&tail;">&f;</describeNote>
	    </td>
	<let name="summary"><summarize>&LOC:path;&tail;/&f;</summarize></let>
	<if><get name="summary" />
	    <then> <tr> <td align="right" valign="top">
	      		    <a href="&f;">[more]</a>
	      		</td>
		        <td colspan="2"> <get name="summary" /> </td>
		   </tr>
	    </then>
	</if>
	</tr>
      </else>
  </if>	  
</repeat>
  <tr> <th bgcolor="#cccccc" width="150"> select label </th>
       <th bgcolor="#cccccc" colspan="2" align="left"> click to create note
       </th>
  </tr>
  <tr> <td valign="top">
    	  <select name="label"> 
	       	   <option selected="selected">(other)</option>
	       	   <option>bug</option>
	       	   <option>note</option>
	       	   <option>suggestion</option>
	  </select>
       </td>
       <td valign="top" align="left">
    	  <input name="op" value="Create New Note" type="submit" />
       </td>
       <td valign="top"> Existing notes can be viewed and edited by clicking
          on their label. 
       </td>
  </tr>
</table>
</form>

<index-bar name="Files">Notes Files HEADER</index-bar>

<define element="File">
  <doc> This is cheating.  We really need to make the index a namespace, and
	look up the actual files in it.  Unfortunately, this doesn't work.
	The problem with the cheat is that if the index gets out of date,
	we're hosed.  We could compare dates...
  </doc>
  <action>
    <tr> <td> <a href="&attributes:name;"><code>&attributes:name;</code></a>
	 </td>
	 <td> &nbsp;
	      <logical op="or">
	        <get name="attributes:title"/>
	        <if> <get name="attributes:dscr"/>
	      	     <then><em><get name="attributes:dscr"/></em>
	        </if>
	        <em><if> <get name="attributes:tdscr" />
	      	    <then> <get name="attributes:tdscr" />
	      	 	   <if> <test match="file">
	      			  <get name="attributes:tdscr" /></test>
	      			<test match="directory">
	      			  <get name="attributes:tdscr" /></test>
	      			<else>file</else>
	      		   </if>	      	    </then>
	      	    <else>(unknown; probably text)</else>
	        </if></em>
	      </logical>
	 </td>
    </tr>
  </action>
</define>

<set name="dirIndex"><include src="&LOC:path;/dirIndex.wi"/></set>

<define element="rejectFile">
  <doc> decide whether to omit a file from the listing
  </doc>
  <action>
    <if> &FORM:all;
	<then> </then>
        <else><test match="~$">&content;</test>
              <test match=".bak$">&content;</test>
              <test match="^[.]">&content;</test>
              <test exact="yes" match="CVS">&content;</test>
	</else>
    </if>
  </action>
</define>
<set name="cvs-controlled"></set>

<if> &npath;
     <then>
       <table bgcolor="yellow" width="90%" cellspacing="0" border="1">
	 <tr> <td valign="top"> <b>Note:</b>
	      </td>
	      <td> This is a source directory listing.  If
		   there's a page here called <code>index.html</code>, that's
		   probably what the browser will show for it, but this can be
		   changed in server configuration files that <ss>WOAD</ss>
		   doesn't understand yet.
	      </td>
	 </tr>
       </table>
     </then>
</if>

<if>&tail;
    <then>
	<h3>Invalid source path <code>&spath;&tail;</code>.</h3>
	<p> The closest valid directory above it is
	    <code><a href="&LOC:path;/">&spath;/</a></code> 
	</p>
    </then>
  <else-if>&dirIndex;
    <then> 
	<table bgcolor="white" border="3">
	  <tr>
	    <th bgcolor="#cccccc"> filename </th>
	    <th bgcolor="#cccccc"> title/<em>description</em> </th>
	  </tr>
	  &dirIndex;
	</table>
    </then>
  </else-if>
    <else>
       <table bgcolor="yellow" width="90%" cellspacing="0" border="1">
	 <tr> <td valign="top"> <b>Note:</b>
	      </td>
	      <td> This directory has not been indexed!  Indexing is done
		   using the <code>woad-index.pl</code> command, which you can
		   find in <code>PIA/src/apps/tools</code>
	      </td>
	 </tr>
       </table>
	<table bgcolor="white">
	<repeat>
	  <foreach entity="f">
	     <text sort><status item="files" src="&LOC:path;" /></text>
	  </foreach>
	  <if><rejectFile>&f;</rejectFile>
	      <else>
		<tr><td align="left"><a href="&f;"><code>&f;</code></a></td>
		    <td> <if> &dirIndex;
			      <then><xget name="dirIndex:&f;:tdscr"/>
			      </then>
			 </if>
		    </td>
		</tr>
	      </else>
	  </if>
	  <if><test exact="yes" match="CVS">&f;</test>
	      <then><set name="cvs-controlled">yes</set></then>
	  </if>
	</repeat>
	</table>
    </else>
</if>
<hide>
<ul></ul><!-- correct indentation -->
</hide>

<if> <get name="cvs-controlled"/>
     <then> Note: this source directory is under CVS control.
     </then>
</if>


<if> <status item="exists" src="&LOC:path;/HEADER.html" />
     <then>

<index-bar name="HEADER">Notes Files HEADER</index-bar>

<table bgcolor="#99ccff" cellspacing="0" border="0" width="100%">
  <tr><td>&nbsp;</td>
  <tr><th align="left">
    <h2><code>&spath;/HEADER.html</code></h2>
    </th>
  </tr>
</table>

<table bgcolor="#ffffff" border="1">
 <tr><td><small>
	   <include src="&LOC:path;/HEADER.html" tagset="HTML" />
	 </small>
     </td>
 </tr>
</table>
     </then>
</if>

<short-footer cvs-id="$Id: src-listing.xh,v 1.10 2000-06-28 01:49:21 steve Exp $" />
</body></html>
